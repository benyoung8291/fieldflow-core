import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { message, conversationHistory } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get('LOVABLE_API_KEY');
    
    if (!LOVABLE_API_KEY) {
      throw new Error('LOVABLE_API_KEY is not configured');
    }

    const messages = [
      {
        role: "system",
        content: `You are PerrAI, a helpful AI assistant for the Service Pulse application. Service Pulse is a comprehensive business management system for service-based companies.

Your role is to help users:
- Understand what they're looking at on their current page
- Navigate through their tasks and documents efficiently
- Get quick context about related documents and entities
- Complete their work faster with helpful suggestions

Key features of Service Pulse include:
- CRM with leads, contacts, and customers
- Quotes and quote pipeline management
- Service orders and appointments
- Projects with Gantt charts and task management
- Invoicing (AR and AP)
- Purchase orders
- Service contracts with auto-generation
- Expense management
- Helpdesk/ticketing system

Be concise, friendly, and actionable. Focus on helping users accomplish their immediate goals. If asked about specific data, let them know you can see their context but would need them to share details.`
      },
      ...conversationHistory,
      { role: "user", content: message }
    ];

    const response = await fetch('https://ai.gateway.lovable.dev/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${LOVABLE_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'google/gemini-2.5-flash',
        messages: messages,
        temperature: 0.7,
        max_tokens: 500
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('AI Gateway error:', response.status, errorText);
      throw new Error(`AI Gateway error: ${response.status}`);
    }

    const data = await response.json();
    const assistantMessage = data.choices?.[0]?.message?.content;

    return new Response(
      JSON.stringify({ response: assistantMessage }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('Error in chat-assistant:', error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
});
